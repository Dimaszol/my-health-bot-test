{% extends "base.html" %}

{% block title %}–ú–æ–∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã - –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç{% endblock %}

{% block content %}
<!-- üìÑ –°–¢–†–ê–ù–ò–¶–ê –î–û–ö–£–ú–ï–ù–¢–û–í -->

<div style="margin-bottom: 2rem;">
    <h1 style="color: #667eea;">üìÑ –ú–æ–∏ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã</h1>
    <p style="color: #666;">
        –£–ø—Ä–∞–≤–ª—è–π—Ç–µ –≤–∞—à–∏–º–∏ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–º–∏ —Ñ–∞–π–ª–∞–º–∏
    </p>
</div>

<!-- üì§ –§–û–†–ú–ê –ó–ê–ì–†–£–ó–ö–ò -->
<div class="card" style="margin-bottom: 2rem;">
    <h3>üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç</h3>
    
    <form id="upload-form" style="margin-top: 1.5rem;">
        <div class="form-group">
            <label>–ù–∞–∑–≤–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
            <input 
                type="text" 
                id="doc-title" 
                placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ê–Ω–∞–ª–∏–∑ –∫—Ä–æ–≤–∏ –æ—Ç 15.01.2025"
            />
        </div>
        
        <div class="form-group">
            <label>–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª</label>
            <input 
                type="file" 
                id="doc-file" 
                accept=".pdf,.docx,.txt,.jpg,.jpeg,.png"
                required
                style="width: 100%; padding: 1rem; border: 2px dashed #667eea; border-radius: 8px; background: #f8f9fa; cursor: pointer;"
            />
            <p style="color: #999; font-size: 0.9rem; margin-top: 0.5rem;">
                –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: PDF, DOCX, TXT, JPG, PNG (–º–∞–∫—Å. 10 –ú–ë)
            </p>
        </div>
        
        <button type="submit" class="btn">
            –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç üì§
        </button>
    </form>
    
    <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div id="upload-progress" style="display: none; margin-top: 1rem;">
        <div style="background: #e0e0e0; border-radius: 10px; overflow: hidden; height: 30px;">
            <div id="progress-bar" class="progress-bar-inner">
                0%
            </div>
        </div>
    </div>
</div>

<!-- üìã –°–ü–ò–°–û–ö –î–û–ö–£–ú–ï–ù–¢–û–í -->
{% if documents %}
<div>
    <h2 style="margin-bottom: 1.5rem;">–ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã ({{ documents|length }})</h2>
    
    {% for doc in documents %}
    <div class="card document-card">
        <div class="document-info">
            <h3 style="margin-bottom: 0.5rem;">{{ doc.title }}</h3>
            <p style="color: #999; font-size: 0.9rem;">
                {% if doc.uploaded_at %}
                    üìÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ: {{ doc.uploaded_at.strftime('%d.%m.%Y %H:%M') }}
                {% else %}
                    üìÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ: –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ
                {% endif %}
                | 
                üìé –¢–∏–ø: {{ doc.file_type }}
            </p>
            
            {% if doc.summary %}
            <details style="margin-top: 1rem;">
                <summary style="cursor: pointer; color: #667eea; font-weight: 600;">
                    üìù –ö—Ä–∞—Ç–∫–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ
                </summary>
                <p style="margin-top: 0.5rem; color: #666; padding: 1rem; background: white; border-radius: 8px;">
                    {{ doc.summary }}
                </p>
            </details>
            {% endif %}
        </div>
        
        <div class="document-actions">
            <button 
                class="btn btn-danger delete-btn"
                data-doc-id="{{ doc.id }}"
                style="padding: 0.5rem 1rem;"
            >
                üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
            </button>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="alert alert-info" style="text-align: center;">
    <div style="font-size: 4rem; margin-bottom: 1rem;">üìÇ</div>
    <h3>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</h3>
    <p>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∞—à –ø–µ—Ä–≤—ã–π –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–π –¥–æ–∫—É–º–µ–Ω—Ç –∏—Å–ø–æ–ª—å–∑—É—è —Ñ–æ—Ä–º—É –≤—ã—à–µ</p>
</div>
{% endif %}

{% endblock %}

{% block extra_styles %}
<style>
    /* –ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä */
    .progress-bar-inner {
        background: linear-gradient(90deg, #667eea, #764ba2);
        height: 100%;
        width: 0%;
        transition: width 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
    }
    
    /* –ö–∞—Ä—Ç–æ—á–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ */
    .document-card {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }
    
    .document-info {
        flex: 1;
        min-width: 300px;
    }
    
    .document-actions {
        display: flex;
        gap: 1rem;
    }
    
    @media (max-width: 768px) {
        .document-card {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .document-actions {
            width: 100%;
        }
        
        .document-actions button {
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block extra_scripts %}
<script>
// üì§ –ó–ê–ì–†–£–ó–ö–ê –î–û–ö–£–ú–ï–ù–¢–ê
const uploadForm = document.getElementById('upload-form');
const uploadProgress = document.getElementById('upload-progress');
const progressBar = document.getElementById('progress-bar');

uploadForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const fileInput = document.getElementById('doc-file');
    const titleInput = document.getElementById('doc-title');
    
    if (!fileInput.files[0]) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª');
        return;
    }
    
    // –°–æ–∑–¥–∞—ë–º FormData
    const formData = new FormData();
    formData.append('file', fileInput.files[0]);
    formData.append('title', titleInput.value || fileInput.files[0].name);
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
    uploadProgress.style.display = 'block';
    progressBar.style.width = '10%';
    progressBar.textContent = '10%';
    
    try {
        const response = await fetch('/api/upload', {
            method: 'POST',
            body: formData
        });
        
        progressBar.style.width = '100%';
        progressBar.textContent = '100%';
        
        const data = await response.json();
        
        if (data.success) {
            alert('‚úÖ –î–æ–∫—É–º–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω!');
            window.location.reload();
        } else {
            alert('‚ùå –û—à–∏–±–∫–∞: ' + data.error);
        }
        
    } catch (error) {
        alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
        console.error('Error:', error);
    } finally {
        uploadProgress.style.display = 'none';
        progressBar.style.width = '0%';
    }
});

// üóëÔ∏è –£–î–ê–õ–ï–ù–ò–ï –î–û–ö–£–ú–ï–ù–¢–ê
document.addEventListener('DOMContentLoaded', function() {
    // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è
    const deleteButtons = document.querySelectorAll('.delete-btn');
    
    deleteButtons.forEach(button => {
        button.addEventListener('click', async function() {
            const docId = this.getAttribute('data-doc-id');
            
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç?')) {
                return;
            }
            
            try {
                const response = await fetch('/api/delete-document/' + docId, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('‚úÖ –î–æ–∫—É–º–µ–Ω—Ç —É–¥–∞–ª—ë–Ω');
                    window.location.reload();
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞: ' + data.error);
                }
                
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
                console.error('Error:', error);
            }
        });
    });
});
</script>
{% endblock %}