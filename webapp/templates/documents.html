{% extends "base.html" %}

{% block title %}{{ t('page_documents_title', lang) }} - {{ t('site_title', lang) }}{% endblock %}

{% block content %}
<!-- üìÑ –°–¢–†–ê–ù–ò–¶–ê –î–û–ö–£–ú–ï–ù–¢–û–í -->

<div style="margin-bottom: 2rem;">
    <h1 style="color: #667eea;">üìÑ {{ t('page_documents_title', lang) }}</h1>
    <p style="color: #666;">
        {{ t('page_documents_subtitle', lang) }}
    </p>
</div>

<!-- üì§ –§–û–†–ú–ê –ó–ê–ì–†–£–ó–ö–ò -->
<div class="card" style="margin-bottom: 2rem;">
    <h3>üì§ {{ t('upload_new_document', lang) }}</h3>
    
    <form id="upload-form" style="margin-top: 1.5rem;">
        <div class="form-group">
            <label>{{ t('document_title_optional', lang) }}</label>
            <input 
                type="text" 
                id="doc-title" 
                placeholder="{{ t('document_title_placeholder', lang) }}"
            />
        </div>
        
        <div class="form-group">
            <label>{{ t('select_file', lang) }}</label>
            <input 
                type="file" 
                id="doc-file" 
                accept=".pdf,.docx,.txt,.jpg,.jpeg,.png"
                required
                style="width: 100%; padding: 1rem; border: 2px dashed #667eea; border-radius: 8px; background: #f8f9fa; cursor: pointer;"
            />
            <p style="color: #999; font-size: 0.9rem; margin-top: 0.5rem;">
                {{ t('supported_formats', lang) }}
            </p>
        </div>
        
        <button type="submit" class="btn">
            {{ t('btn_upload_document', lang) }} üì§
        </button>
    </form>
    
    <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div id="upload-progress" style="display: none; margin-top: 1rem;">
        <div style="background: #e0e0e0; border-radius: 10px; overflow: hidden; height: 30px;">
            <div id="progress-bar" class="progress-bar-inner">
                0%
            </div>
        </div>
    </div>
</div>

<!-- üìã –°–ü–ò–°–û–ö –î–û–ö–£–ú–ï–ù–¢–û–í -->
{% if documents %}
<div>
    <h2 style="margin-bottom: 1.5rem;">{{ t('uploaded_documents', lang) }} ({{ documents|length }})</h2>
    
    {% for doc in documents %}
    <div class="card document-card">
        <div class="document-info">
            <h3 style="margin-bottom: 0.5rem;">{{ doc.title }}</h3>
            <p style="color: #999; font-size: 0.9rem;">
                {% if doc.uploaded_at %}
                    üìÖ {{ t('document_uploaded', lang) }}: {{ doc.uploaded_at.strftime('%d.%m.%Y %H:%M') }}
                {% else %}
                    üìÖ {{ t('document_uploaded', lang) }}: {{ t('unknown', lang) }}
                {% endif %}
                | 
                üìé {{ t('document_type', lang) }}: {{ doc.file_type }}
            </p>
            
            {% if doc.summary %}
            <details style="margin-top: 1rem;">
                <summary style="cursor: pointer; color: #667eea; font-weight: 600;">
                    üìù {{ t('document_summary', lang) }}
                </summary>
                <p style="margin-top: 0.5rem; color: #666; padding: 1rem; background: white; border-radius: 8px;">
                    {{ doc.summary }}
                </p>
            </details>
            {% endif %}
        </div>
        
        <div class="document-actions">
            <button 
                class="btn btn-danger delete-btn"
                data-doc-id="{{ doc.id }}"
                style="padding: 0.5rem 1rem;"
            >
                üóëÔ∏è {{ t('document_delete', lang) }}
            </button>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="alert alert-info" style="text-align: center;">
    <div style="font-size: 4rem; margin-bottom: 1rem;">üìÇ</div>
    <h3>{{ t('no_documents_yet', lang) }}</h3>
    <p>{{ t('no_documents_action', lang) }}</p>
</div>
{% endif %}

{% endblock %}

{% block extra_styles %}
<style>
    /* –ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä */
    .progress-bar-inner {
        background: linear-gradient(90deg, #667eea, #764ba2);
        height: 100%;
        width: 0%;
        transition: width 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
    }
    
    /* –ö–∞—Ä—Ç–æ—á–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ */
    .document-card {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }
    
    .document-info {
        flex: 1;
        min-width: 300px;
    }
    
    .document-actions {
        display: flex;
        gap: 1rem;
    }
    
    @media (max-width: 768px) {
        .document-card {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .document-actions {
            width: 100%;
        }
        
        .document-actions button {
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block extra_scripts %}
<script>
// üì§ –ó–ê–ì–†–£–ó–ö–ê –î–û–ö–£–ú–ï–ù–¢–ê
const uploadForm = document.getElementById('upload-form');
const uploadProgress = document.getElementById('upload-progress');
const progressBar = document.getElementById('progress-bar');

uploadForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const fileInput = document.getElementById('doc-file');
    const titleInput = document.getElementById('doc-title');
    
    if (!fileInput.files[0]) {
        alert('{{ t("please_select_file", lang) }}');
        return;
    }
    
    // –°–æ–∑–¥–∞—ë–º FormData
    const formData = new FormData();
    formData.append('file', fileInput.files[0]);
    formData.append('title', titleInput.value || fileInput.files[0].name);
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
    uploadProgress.style.display = 'block';
    progressBar.style.width = '10%';
    progressBar.textContent = '10%';
    
    try {
        const response = await fetch('/api/upload', {
            method: 'POST',
            body: formData
        });
        
        progressBar.style.width = '100%';
        progressBar.textContent = '100%';
        
        const data = await response.json();
        
        if (data.success) {
            alert('‚úÖ {{ t("success_document_uploaded", lang) }}!');
            window.location.reload();
        } else {
            alert('‚ùå {{ t("error", lang) }}: ' + data.error);
        }
        
    } catch (error) {
        alert('‚ùå {{ t("error_server", lang) }}');
        console.error('Error:', error);
    } finally {
        uploadProgress.style.display = 'none';
        progressBar.style.width = '0%';
    }
});

// üóëÔ∏è –£–î–ê–õ–ï–ù–ò–ï –î–û–ö–£–ú–ï–ù–¢–ê
document.addEventListener('DOMContentLoaded', function() {
    // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è
    const deleteButtons = document.querySelectorAll('.delete-btn');
    
    deleteButtons.forEach(button => {
        button.addEventListener('click', async function() {
            const docId = this.getAttribute('data-doc-id');
            
            if (!confirm('{{ t("confirm_delete_document", lang) }}')) {
                return;
            }
            
            try {
                const response = await fetch('/api/delete-document/' + docId, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('‚úÖ {{ t("document_deleted", lang) }}');
                    window.location.reload();
                } else {
                    alert('‚ùå {{ t("error", lang) }}: ' + data.error);
                }
                
            } catch (error) {
                alert('‚ùå {{ t("error_server", lang) }}');
                console.error('Error:', error);
            }
        });
    });
});
</script>
{% endblock %}