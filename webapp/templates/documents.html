{% extends "base.html" %}

{% block title %}{{ t('page_documents_title', lang) }} - {{ t('site_title', lang) }}{% endblock %}

{% block content %}
<!-- üìÑ –°–¢–†–ê–ù–ò–¶–ê –î–û–ö–£–ú–ï–ù–¢–û–í -->

<div style="margin-bottom: 2rem;">
    <h1 style="color: #667eea;">üìÑ {{ t('page_documents_title', lang) }}</h1>
    <p style="color: #666;">
        {{ t('page_documents_subtitle', lang) }}
    </p>
</div>

<!-- üì§ –§–û–†–ú–ê –ó–ê–ì–†–£–ó–ö–ò -->
<div class="card" style="margin-bottom: 2rem;" id="upload-card">
    <h3>üì§ {{ t('upload_new_document', lang) }}</h3>
    
    <form id="upload-form" style="margin-top: 1.5rem;">
        <div class="form-group">
            <label>{{ t('document_title_optional', lang) }}</label>
            <input 
                type="text" 
                id="doc-title" 
                placeholder="{{ t('document_title_placeholder', lang) }}"
            />
        </div>
        
        <div class="form-group">
            <label>{{ t('select_file', lang) }}</label>
            <input 
                type="file" 
                id="doc-file" 
                accept=".pdf,.docx,.txt,.jpg,.jpeg,.png"
                required
                style="width: 100%; padding: 1rem; border: 2px dashed #667eea; border-radius: 8px; background: #f8f9fa; cursor: pointer;"
            />
            <p style="color: #999; font-size: 0.9rem; margin-top: 0.5rem;">
                {{ t('supported_formats', lang) }}
            </p>
        </div>
        
        <button type="submit" class="btn">
            {{ t('btn_upload_document', lang) }} üì§
        </button>
    </form>
</div>

<!-- üîÑ –ö–ê–†–¢–û–ß–ö–ê –ü–†–û–ì–†–ï–°–°–ê (—Å–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
<div id="progress-card" class="card" style="display: none; margin-bottom: 2rem;">
    <div style="text-align: center;">
        <div class="spinner-container">
            <div class="spinner"></div>
        </div>
        <h3 id="progress-title" style="margin: 1rem 0; color: #667eea;">üì§ –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª...</h3>
        <p id="progress-description" style="color: #999;">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ...</p>
        
        <!-- –°–ø–∏—Å–æ–∫ —ç—Ç–∞–ø–æ–≤ -->
        <div class="progress-steps" style="margin-top: 1.5rem;">
            <div class="progress-step" data-step="upload">
                <span class="step-icon">‚è≥</span>
                <span class="step-text">–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞</span>
            </div>
            <div class="progress-step" data-step="extract">
                <span class="step-icon">‚óã</span>
                <span class="step-text">–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞</span>
            </div>
            <div class="progress-step" data-step="analyze">
                <span class="step-icon">‚óã</span>
                <span class="step-text">–ê–Ω–∞–ª–∏–∑ AI</span>
            </div>
            <div class="progress-step" data-step="save">
                <span class="step-icon">‚óã</span>
                <span class="step-text">–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ</span>
            </div>
        </div>
    </div>
</div>

<!-- üìã –°–ü–ò–°–û–ö –î–û–ö–£–ú–ï–ù–¢–û–í -->
{% if documents %}
<div id="documents-list">
    <h2 style="margin-bottom: 1.5rem;">{{ t('uploaded_documents', lang) }} ({{ documents|length }})</h2>
    
    {% for doc in documents %}
    <div class="card document-card" data-doc-id="{{ doc.id }}">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–∞—Ä—Ç–æ—á–∫–∏ (–≤—Å–µ–≥–¥–∞ –≤–∏–¥–∏–º—ã–π) -->
        <div class="document-header">
            <div class="document-header-left">
                <h3 style="margin: 0;">üìÑ {{ doc.title }}</h3>
                <p style="color: #999; font-size: 0.9rem; margin: 0.3rem 0 0 0;">
                    üìÖ {{ doc.uploaded_at.strftime('%d.%m.%Y %H:%M') if doc.uploaded_at else t('unknown', lang) }}
                </p>
            </div>
            
            <!-- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ: ID –≤ data-–∞—Ç—Ä–∏–±—É—Ç–µ -->
            <button class="btn-toggle" type="button" data-doc-id="{{ doc.id }}">
                <span class="toggle-icon">‚ñ∂</span>
                <span class="toggle-text">–ü–æ–∫–∞–∑–∞—Ç—å</span>
            </button>
        </div>
        
        <!-- –†–∞—Å–∫—Ä—ã–≤–∞—é—â–µ–µ—Å—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ -->
        <div class="document-body" style="display: none;">
            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e2e8f0;">
                <p style="color: #666; margin-bottom: 1rem;">
                    <strong>üìù –¢–∏–ø:</strong> {{ doc.file_type }}
                </p>
                
                <!-- ü§ñ –ü–û–ö–ê–ó–´–í–ê–ï–ú AI-–ê–ù–ê–õ–ò–ó -->
                {% if doc.raw_text %}
                <div style="background: #f0f7ff; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #667eea;">
                    <h4 style="color: #667eea; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                        <span>ü§ñ</span>
                        <span>AI-–∞–Ω–∞–ª–∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞</span>
                    </h4>
                    <div style="max-height: 400px; overflow-y: auto; background: white; padding: 1rem; border-radius: 6px;">
                        <!-- ‚úÖ –ò–ó–ú–ï–ù–ò–õ–ò: –¥–æ–±–∞–≤–∏–ª–∏ | markdown –ø–µ—Ä–µ–¥ | safe -->
                        <div style="color: #333; line-height: 1.6;">{{ doc.raw_text | markdown | safe }}</div>
                    </div>
                </div>
                {% else %}
                <div style="background: #fff3cd; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem; text-align: center; border-left: 4px solid #ffc107;">
                    <p style="color: #856404; margin: 0; font-weight: 600;">‚ö†Ô∏è AI-–∞–Ω–∞–ª–∏–∑ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω</p>
                    <p style="color: #856404; margin: 0.5rem 0 0 0; font-size: 0.9rem;">–î–æ–∫—É–º–µ–Ω—Ç –Ω–µ –±—ã–ª –æ–±—Ä–∞–±–æ—Ç–∞–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–Ω–æ–≤–æ.</p>
                </div>
                {% endif %}
                
                <div class="document-actions">
                    <button 
                        class="btn btn-danger delete-btn"
                        data-doc-id="{{ doc.id }}"
                        style="padding: 0.5rem 1rem;"
                    >
                        üóëÔ∏è {{ t('document_delete', lang) }}
                    </button>
                </div>
            </div>
        </div>
    </div>  <!-- ‚úÖ –í–ê–ñ–ù–û: –ó–∞–∫—Ä—ã–≤–∞—é—â–∏–π —Ç–µ–≥ –¥–ª—è document-card -->
    {% endfor %}
</div>
{% else %}
<div class="alert alert-info" style="text-align: center;">
    <div style="font-size: 4rem; margin-bottom: 1rem;">üìÇ</div>
    <h3>{{ t('no_documents_yet', lang) }}</h3>
    <p>{{ t('no_documents_action', lang) }}</p>
</div>
{% endif %}

{% endblock %}

{% block extra_styles %}
<style>
    /* ========================================
       üîÑ SPINNER –ò –ü–†–û–ì–†–ï–°–°
       ======================================== */
    
    .spinner-container {
        display: flex;
        justify-content: center;
        margin: 1rem 0;
    }
    
    .spinner {
        width: 60px;
        height: 60px;
        border: 4px solid #e2e8f0;
        border-top-color: #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    /* –≠—Ç–∞–ø—ã –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ */
    .progress-steps {
        display: flex;
        justify-content: space-around;
        max-width: 600px;
        margin: 0 auto;
    }
    
    .progress-step {
        text-align: center;
        flex: 1;
    }
    
    .step-icon {
        display: block;
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }
    
    .step-text {
        display: block;
        font-size: 0.9rem;
        color: #999;
    }
    
    .progress-step.active .step-icon {
        animation: pulse 1s infinite;
    }
    
    .progress-step.completed .step-icon {
        color: #28a745;
    }
    
    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
    }
    
    /* ========================================
       üìÑ –ö–ê–†–¢–û–ß–ö–ê –î–û–ö–£–ú–ï–ù–¢–ê (–ê–ö–ö–û–†–î–ï–û–ù)
       ======================================== */
    
    .document-card {
        margin-bottom: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    /* Badge "–ù–û–í–´–ô" */
    .document-card.new::before {
        content: '‚ú® –ù–û–í–´–ô';
        position: absolute;
        top: 10px;
        right: 10px;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 0.3rem 0.8rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 700;
        z-index: 10;
        animation: fadeOut 3s forwards;
    }
    
    @keyframes fadeOut {
        0%, 90% { opacity: 1; }
        100% { opacity: 0; }
    }
    
    /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–∞—Ä—Ç–æ—á–∫–∏ */
    .document-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
        user-select: none;
    }
    
    .document-header-left {
        flex: 1;
    }
    
    .btn-toggle {
        background: transparent;
        border: 2px solid #667eea;
        color: #667eea;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        transition: all 0.3s ease;
        white-space: nowrap;
    }
    
    .btn-toggle:hover {
        background: #667eea;
        color: white;
    }
    
    .toggle-icon {
        transition: transform 0.3s ease;
        display: inline-block;
    }
    
    /* –ö–æ–≥–¥–∞ —Ä–∞—Å–∫—Ä—ã—Ç */
    .document-card.expanded .toggle-icon {
        transform: rotate(90deg);
    }
    
    .document-card.expanded .btn-toggle {
        background: #667eea;
        color: white;
    }
    
    /* –¢–µ–ª–æ –∫–∞—Ä—Ç–æ—á–∫–∏ */
    .document-body {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.4s ease-in-out;
    }
    
    .document-card.expanded .document-body {
        max-height: 1000px;
    }
    
    /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ */
    .document-card.new-animated {
        animation: slideInFade 0.6s ease-out;
    }
    
    @keyframes slideInFade {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –Ω–æ–≤–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ */
    .document-card.new {
        border: 2px solid #667eea;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    
    /* ========================================
       üé® –ö–ù–û–ü–ö–ò –ò –î–ï–ô–°–¢–í–ò–Ø
       ======================================== */
    
    .document-actions {
        display: flex;
        gap: 1rem;
        margin-top: 1rem;
    }
    
    .btn-danger {
        background: #dc3545;
    }
    
    .btn-danger:hover {
        background: #c82333;
    }
    /* ========================================
       üìù –°–¢–ò–õ–ò –î–õ–Ø MARKDOWN –í –î–û–ö–£–ú–ï–ù–¢–ê–•
       ======================================== */
    
    .document-body strong {
        font-weight: 700;
        color: #2c3e50;
    }
    
    .document-body em {
        font-style: italic;
        color: #555;
    }
    
    .document-body ul, 
    .document-body ol {
        margin-left: 1.5rem;
        margin-bottom: 1rem;
    }
    
    .document-body li {
        margin-bottom: 0.5rem;
    }
    
    .document-body p {
        margin-bottom: 0.8rem;
    }
    
    .document-body h3 {
        color: #667eea;
        font-size: 1.1rem;
        margin-top: 1.2rem;
        margin-bottom: 0.5rem;
        font-weight: 600;
    }
    /* ========================================
       üì± –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨
       ======================================== */
    
    @media (max-width: 768px) {
        .document-header {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .btn-toggle {
            width: 100%;
            justify-content: center;
        }
        
        .progress-steps {
            flex-direction: column;
            gap: 1rem;
        }
        
        .progress-step {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .step-icon {
            font-size: 1.5rem;
            margin: 0;
        }
    }
</style>
{% endblock %}

{% block extra_scripts %}
<script>
// ========================================
// üîÑ –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï
// ========================================

let currentOpenDocId = null; // ID —Ç–µ–∫—É—â–µ–≥–æ –æ—Ç–∫—Ä—ã—Ç–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (–∞–∫–∫–æ—Ä–¥–µ–æ–Ω)

// ========================================
// üîò –û–ë–†–ê–ë–û–¢–ß–ò–ö –ö–ù–û–ü–û–ö TOGGLE
// ========================================

document.addEventListener('DOMContentLoaded', function() {
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–∞ –≤—Å–µ –∫–Ω–æ–ø–∫–∏ toggle
    const toggleButtons = document.querySelectorAll('.btn-toggle');
    
    toggleButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.stopPropagation(); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ —Å–æ–±—ã—Ç–∏—è
            const docId = parseInt(this.getAttribute('data-doc-id'));
            toggleDocument(docId);
        });
    });
});

// ========================================
// üì§ –ó–ê–ì–†–£–ó–ö–ê –î–û–ö–£–ú–ï–ù–¢–ê
// ========================================

const uploadForm = document.getElementById('upload-form');
const uploadCard = document.getElementById('upload-card');
const progressCard = document.getElementById('progress-card');
const documentsList = document.getElementById('documents-list');

uploadForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const fileInput = document.getElementById('doc-file');
    const titleInput = document.getElementById('doc-title');
    
    if (!fileInput.files[0]) {
        alert('{{ t("please_select_file", lang) }}');
        return;
    }
    
    // –°–æ–∑–¥–∞—ë–º FormData
    const formData = new FormData();
    formData.append('file', fileInput.files[0]);
    formData.append('title', titleInput.value || '');
    
    // –°–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
    uploadCard.style.display = 'none';
    progressCard.style.display = 'block';
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∏–º—É–ª—è—Ü–∏—é —ç—Ç–∞–ø–æ–≤
    simulateProgressSteps();
    
    try {
        const response = await fetch('/api/upload', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —ç—Ç–∞–ø
            updateProgressStep('save', 'completed', '‚úì');
            updateProgressTitle('‚úÖ –î–æ–∫—É–º–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω!');
            
            // –ß–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—É –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º –Ω–æ–≤–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞
            setTimeout(() => {
                window.location.href = window.location.pathname + '?new_doc_id=' + data.document_id;
            }, 1500);
        } else {
            alert('‚ùå {{ t("error", lang) }}: ' + data.error);
            resetUploadForm();
        }
        
    } catch (error) {
        alert('‚ùå {{ t("error_server", lang) }}');
        console.error('Error:', error);
        resetUploadForm();
    }
});

// ========================================
// üîÑ –°–ò–ú–£–õ–Ø–¶–ò–Ø –≠–¢–ê–ü–û–í –û–ë–†–ê–ë–û–¢–ö–ò
// ========================================

function simulateProgressSteps() {
    const steps = [
        { name: 'upload', icon: '‚è≥', text: '–ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª...', delay: 500 },
        { name: 'extract', icon: '‚è≥', text: '–ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç —á–µ—Ä–µ–∑ AI...', delay: 3000 },
        { name: 'analyze', icon: '‚è≥', text: '–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ...', delay: 5000 },
        { name: 'save', icon: '‚è≥', text: '–°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö...', delay: 7000 }
    ];
    
    steps.forEach((step, index) => {
        setTimeout(() => {
            // –ü—Ä–µ–¥—ã–¥—É—â–∏–π —ç—Ç–∞–ø –∑–∞–≤–µ—Ä—à—ë–Ω
            if (index > 0) {
                updateProgressStep(steps[index - 1].name, 'completed', '‚úì');
            }
            
            // –¢–µ–∫—É—â–∏–π —ç—Ç–∞–ø –∞–∫—Ç–∏–≤–µ–Ω
            updateProgressStep(step.name, 'active', step.icon);
            updateProgressTitle(step.text);
        }, step.delay);
    });
}

function updateProgressStep(stepName, status, icon) {
    const step = document.querySelector(`.progress-step[data-step="${stepName}"]`);
    if (step) {
        step.className = `progress-step ${status}`;
        step.querySelector('.step-icon').textContent = icon;
    }
}

function updateProgressTitle(text) {
    document.getElementById('progress-title').textContent = text;
}

function resetUploadForm() {
    progressCard.style.display = 'none';
    uploadCard.style.display = 'block';
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ —ç—Ç–∞–ø—ã
    document.querySelectorAll('.progress-step').forEach(step => {
        step.className = 'progress-step';
        step.querySelector('.step-icon').textContent = '‚óã';
    });
}

// ========================================
// üìÑ –ê–ö–ö–û–†–î–ï–û–ù –î–û–ö–£–ú–ï–ù–¢–û–í
// ========================================

function toggleDocument(docId) {
    const card = document.querySelector(`.document-card[data-doc-id="${docId}"]`);
    const body = card.querySelector('.document-body');
    const toggleText = card.querySelector('.toggle-text');
    const isExpanded = card.classList.contains('expanded');
    
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ä–∞–Ω–µ–µ –æ—Ç–∫—Ä—ã—Ç—ã–π –¥–æ–∫—É–º–µ–Ω—Ç (–∞–∫–∫–æ—Ä–¥–µ–æ–Ω)
    if (currentOpenDocId && currentOpenDocId !== docId) {
        const prevCard = document.querySelector(`.document-card[data-doc-id="${currentOpenDocId}"]`);
        if (prevCard) {
            prevCard.classList.remove('expanded');
            prevCard.querySelector('.document-body').style.display = 'none';
            prevCard.querySelector('.toggle-text').textContent = '–ü–æ–∫–∞–∑–∞—Ç—å';
        }
    }
    
    // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –¥–æ–∫—É–º–µ–Ω—Ç
    if (isExpanded) {
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º
        card.classList.remove('expanded');
        body.style.display = 'none';
        toggleText.textContent = '–ü–æ–∫–∞–∑–∞—Ç—å';
        currentOpenDocId = null;
    } else {
        // –û—Ç–∫—Ä—ã–≤–∞–µ–º
        card.classList.add('expanded');
        body.style.display = 'block';
        toggleText.textContent = '–°–∫—Ä—ã—Ç—å';
        currentOpenDocId = docId;
        
        // –£–±–∏—Ä–∞–µ–º badge "–ù–û–í–´–ô" –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∫–ª–∏–∫–µ
        card.classList.remove('new');
    }
}

// ========================================
// üóëÔ∏è –£–î–ê–õ–ï–ù–ò–ï –î–û–ö–£–ú–ï–ù–¢–ê
// ========================================

document.addEventListener('DOMContentLoaded', function() {
    const deleteButtons = document.querySelectorAll('.delete-btn');
    
    deleteButtons.forEach(button => {
        button.addEventListener('click', async function(e) {
            e.stopPropagation(); // –ù–µ —Ä–∞—Å–∫—Ä—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ
            
            const docId = this.getAttribute('data-doc-id');
            
            if (!confirm('{{ t("confirm_delete_document", lang) }}')) {
                return;
            }
            
            try {
                const response = await fetch('/api/delete-document/' + docId, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('‚úÖ {{ t("document_deleted", lang) }}');
                    window.location.reload();
                } else {
                    alert('‚ùå {{ t("error", lang) }}: ' + data.error);
                }
                
            } catch (error) {
                alert('‚ùå {{ t("error_server", lang) }}');
                console.error('Error:', error);
            }
        });
    });
});

// ========================================
// ‚ú® –ê–í–¢–û–û–¢–ö–†–´–¢–ò–ï –ù–û–í–û–ì–û –î–û–ö–£–ú–ï–ù–¢–ê
// ========================================

// –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –Ω–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç
document.addEventListener('DOMContentLoaded', function() {
    // –ï—Å–ª–∏ –≤ URL –µ—Å—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä ?new_doc_id=X, –æ—Ç–∫—Ä—ã–≤–∞–µ–º —ç—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç
    const urlParams = new URLSearchParams(window.location.search);
    const newDocId = urlParams.get('new_doc_id');
    
    if (newDocId) {
        const newCard = document.querySelector(`.document-card[data-doc-id="${newDocId}"]`);
        if (newCard) {
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å—ã –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –∏ badge
            newCard.classList.add('new', 'new-animated');
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å–∫—Ä—ã–≤–∞–µ–º
            toggleDocument(parseInt(newDocId));
            
            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –¥–æ–∫—É–º–µ–Ω—Ç—É
            newCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // –£–¥–∞–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä –∏–∑ URL (—á—Ç–æ–±—ã –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–ª—Å—è badge)
            window.history.replaceState({}, document.title, window.location.pathname);
        }
    }
});
</script>
{% endblock %}