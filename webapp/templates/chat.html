{% extends "base.html" %}

{% block title %}{{ t('page_chat_title', lang) }} - {{ t('site_title', lang) }}{% endblock %}

{% block content %}
<!-- üí¨ –ß–ê–¢ –° –ò–ò -->

<div style="margin-bottom: 2rem;">
    <h1 style="color: #667eea;">üí¨ {{ t('page_chat_title', lang) }}</h1>
    <p style="color: #666;">
        {{ t('page_chat_subtitle', lang) }}
    </p>
</div>

<!-- üì± –û–ö–ù–û –ß–ê–¢–ê -->
<div id="chat-container" style="
    background: #f8f9fa;
    border-radius: 15px;
    height: 500px;
    overflow-y: auto;
    padding: 2rem;
    margin-bottom: 1.5rem;
    border: 2px solid #e0e0e0;
">
    <!-- –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π -->
    {% if chat_history %}
        {% for msg in chat_history %}
        <div class="message {% if msg.role == 'user' %}user-message{% else %}ai-message{% endif %}">
            <div class="message-bubble">
                {{ msg.message }}
            </div>
            <div class="message-time">
                {{ msg.timestamp.strftime('%H:%M') if msg.timestamp else '' }}
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div style="text-align: center; color: #999; margin-top: 5rem;">
            <div style="font-size: 4rem; margin-bottom: 1rem;">ü§ñ</div>
            <p style="font-size: 1.1rem;">{{ t('chat_greeting', lang) }}</p>
            <p>{{ t('chat_start_conversation', lang) }}</p>
        </div>
    {% endif %}
    
    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∞–Ω–∏—è -->
    <div id="typing-indicator" style="display: none;">
        <div class="message ai-message">
            <div class="message-bubble">
                <span class="typing-dots">
                    <span></span><span></span><span></span>
                </span>
            </div>
        </div>
    </div>
</div>

<!-- ‚úçÔ∏è –§–û–†–ú–ê –í–í–û–î–ê –°–û–û–ë–©–ï–ù–ò–Ø -->
<form id="chat-form" style="display: flex; gap: 1rem;">
    <input 
        type="text" 
        id="message-input" 
        placeholder="{{ t('chat_placeholder', lang) }}"
        style="
            flex: 1;
            padding: 1rem 1.5rem;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 1rem;
        "
        required
    />
    <button type="submit" class="btn" style="border-radius: 25px; padding: 1rem 2rem;">
        {{ t('btn_send', lang) }} üì§
    </button>
</form>

<!-- ‚ÑπÔ∏è –ü–û–î–°–ö–ê–ó–ö–ò -->
<div style="margin-top: 2rem; padding: 1rem; background: #fff3cd; border-radius: 10px; border-left: 4px solid #ffc107;">
    <strong>üí° {{ t('chat_examples_title', lang) }}:</strong>
    <ul style="margin-top: 0.5rem; margin-left: 1.5rem; color: #856404;">
        <li>{{ t('chat_example_1', lang) }}</li>
        <li>{{ t('chat_example_2', lang) }}</li>
        <li>{{ t('chat_example_3', lang) }}</li>
        <li>{{ t('chat_example_4', lang) }}</li>
    </ul>
</div>

{% endblock %}

{% block extra_styles %}
<style>
    /* üí¨ –°–¢–ò–õ–ò –°–û–û–ë–©–ï–ù–ò–ô */
    .message {
        margin-bottom: 1.5rem;
        display: flex;
        flex-direction: column;
    }
    
    .user-message {
        align-items: flex-end;
    }
    
    .ai-message {
        align-items: flex-start;
    }
    
    .message-bubble {
        max-width: 70%;
        padding: 1rem 1.5rem;
        border-radius: 15px;
        word-wrap: break-word;
    }
    
    .user-message .message-bubble {
        background: #667eea;
        color: white;
        border-bottom-right-radius: 5px;
    }
    
    .ai-message .message-bubble {
        background: white;
        color: #333;
        border: 1px solid #e0e0e0;
        border-bottom-left-radius: 5px;
    }
    
    .message-time {
        font-size: 0.75rem;
        color: #999;
        margin-top: 0.3rem;
        padding: 0 0.5rem;
    }
    
    /* ‚è≥ –ò–ù–î–ò–ö–ê–¢–û–† –ü–ï–ß–ê–¢–ê–ù–ò–Ø */
    .typing-dots {
        display: flex;
        gap: 5px;
    }
    
    .typing-dots span {
        width: 8px;
        height: 8px;
        background: #999;
        border-radius: 50%;
        animation: typing 1.4s infinite;
    }
    
    .typing-dots span:nth-child(2) {
        animation-delay: 0.2s;
    }
    
    .typing-dots span:nth-child(3) {
        animation-delay: 0.4s;
    }
    
    @keyframes typing {
        0%, 60%, 100% {
            transform: translateY(0);
        }
        30% {
            transform: translateY(-10px);
        }
    }
    
    /* üì± –ê–í–¢–û–°–ö–†–û–õ–õ */
    #chat-container {
        scroll-behavior: smooth;
    }
</style>
{% endblock %}

{% block extra_scripts %}
<script>
// üöÄ JAVASCRIPT –î–õ–Ø –ß–ê–¢–ê

const chatForm = document.getElementById('chat-form');
const messageInput = document.getElementById('message-input');
const chatContainer = document.getElementById('chat-container');
const typingIndicator = document.getElementById('typing-indicator');

// üì§ –û–¢–ü–†–ê–í–ö–ê –°–û–û–ë–©–ï–ù–ò–Ø
chatForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const message = messageInput.value.trim();
    if (!message) return;
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    addMessage(message, 'user');
    messageInput.value = '';
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∞–Ω–∏—è
    typingIndicator.style.display = 'block';
    scrollToBottom();
    
    try {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ API
        const response = await fetch('/api/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ message: message })
        });
        
        const data = await response.json();
        
        // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
        typingIndicator.style.display = 'none';
        
        if (data.success) {
            // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –ò–ò
            addMessage(data.response, 'ai');
        } else {
            // –û—à–∏–±–∫–∞ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            addMessage('{{ t("error_server", lang) }}: ' + data.error, 'ai');
        }
        
    } catch (error) {
        typingIndicator.style.display = 'none';
        addMessage('{{ t("error_server", lang) }}', 'ai');
        console.error('Error:', error);
    }
});

// üí¨ –î–û–ë–ê–í–õ–ï–ù–ò–ï –°–û–û–ë–©–ï–ù–ò–Ø –í –ß–ê–¢
function addMessage(text, role) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${role}-message`;
    
    const now = new Date();
    const time = now.getHours().toString().padStart(2, '0') + ':' + 
                 now.getMinutes().toString().padStart(2, '0');
    
    messageDiv.innerHTML = `
        <div class="message-bubble">
            ${text}
        </div>
        <div class="message-time">${time}</div>
    `;
    
    // –í—Å—Ç–∞–≤–ª—è–µ–º –ø–µ—Ä–µ–¥ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–º –ø–µ—á–∞—Ç–∞–Ω–∏—è
    chatContainer.insertBefore(messageDiv, typingIndicator);
    scrollToBottom();
}

// üìú –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–ö–†–£–¢–ö–ê –í–ù–ò–ó
function scrollToBottom() {
    setTimeout(() => {
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }, 100);
}

// –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
window.addEventListener('load', scrollToBottom);
</script>
{% endblock %}